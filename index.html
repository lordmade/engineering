<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Vynix AI â€¢ CAPS Education Portal</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet"/>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-remote-config-compat.js"></script>

  <style>
    :root {
      --bg-page: #f8fafc;
      --bg-card: #ffffff;
      --primary: #2563eb; /* Educational Blue */
      --primary-hover: #1d4ed8;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --user-msg: #f1f5f9;
      --ai-msg: #eff6ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background-color: var(--bg-page);
      color: var(--text-main);
      font-family: 'Plus Jakarta Sans', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      padding: 1rem 2rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .cap-badge {
      background: #dcfce7;
      color: #166534;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    /* Chat Area */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .message {
      max-width: 80%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } }

    .message.user { align-self: flex-end; }
    .message.ai { align-self: flex-start; }

    .msg-content {
      padding: 1rem 1.25rem;
      border-radius: 18px;
      font-size: 0.95rem;
      line-height: 1.6;
      position: relative;
    }

    .message.user .msg-content {
      background: var(--user-msg);
      color: var(--text-main);
      border-bottom-right-radius: 4px;
    }

    .message.ai .msg-content {
      background: var(--ai-msg);
      color: var(--text-main);
      border: 1px solid #dbeafe;
      border-bottom-left-radius: 4px;
    }

    .sender-label {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    /* Input Area */
    .footer {
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 1.5rem;
    }

    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      background: #f1f5f9;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid var(--border);
    }

    .input-field {
      flex: 1;
      border: none;
      background: transparent;
      padding: 0.75rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      outline: none;
    }

    .send-btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .send-btn:hover { background: var(--primary-hover); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Loading dots */
    .loader { display: none; gap: 4px; }
    .loading .loader { display: flex; }
    .loading .icon { display: none; }
    .dot { width: 5px; height: 5px; background: white; border-radius: 50%; animation: bounce 0.5s infinite alternate; }
    @keyframes bounce { to { transform: translateY(-4px); } }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>
</head>
<body>

  <header class="header">
    <div class="logo">
      <span class="material-symbols-rounded">menu_book</span>
      VYNIX AI
      <span class="cap-badge">CAPS CURRICULUM</span>
    </div>
    <button onclick="firebase.auth().signOut()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.8rem;">Sign Out</button>
  </header>

  <main class="chat-container" id="chatContainer">
    <div class="message ai">
      <div class="sender-label">Vynix AI</div>
      <div class="msg-content">
        Hello! I am <strong>Vynix AI</strong>, your educational assistant. I specialize in the South African CAPS curriculum. How can I help you with your studies today?
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="input-wrapper" id="inputWrapper">
      <input type="text" id="userInput" class="input-field" placeholder="Ask about a CAPS subject (e.g. Grade 12 Math)..." autocomplete="off">
      <button id="sendBtn" class="send-btn">
        <span class="material-symbols-rounded icon">send</span>
        <div class="loader">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
      </button>
    </div>
  </footer>

  <script>
    // 1. Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      projectId: "fire-b-a8878",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const remoteConfig = firebase.remoteConfig();

    let XAI_API_KEY = "";
    const MODEL_ID = "grok-4-1-fast-reasoning";
    
    // 2. Strict Educational System Instruction
    const SYSTEM_PROMPT = `You are Vynix AI, a helpful and professional educational assistant. 
    Your primary goal is to help students with the South African CAPS curriculum (Grades R-12). 
    1. Always identify as Vynix AI. 
    2. Be helpful, encouraging, and clear in educational explanations.
    3. If the user asks about anything NOT related to education or the CAPS curriculum, politely decline and request an educative request instead. 
    4. Provide structured information (bullet points) for complex topics.`;

    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const inputWrapper = document.getElementById('inputWrapper');

    auth.onAuthStateChanged(user => {
      if (!user) window.location.href = 'index.html';
      else initConfig();
    });

    async function initConfig() {
      remoteConfig.settings = { minimumFetchIntervalMillis: 0 };
      try {
        await remoteConfig.fetchAndActivate();
        XAI_API_KEY = remoteConfig.getValue('xai_api_key').asString();
      } catch (err) { console.error("Config fetch failed"); }
    }

    function appendMessage(role, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${role}`;
      msgDiv.innerHTML = `
        <div class="sender-label">${role === 'user' ? 'Student' : 'Vynix AI'}</div>
        <div class="msg-content">${text.replace(/\n/g, '<br>')}</div>
      `;
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
      const query = userInput.value.trim();
      if (!query || !XAI_API_KEY) return;

      appendMessage('user', query);
      userInput.value = '';
      sendBtn.disabled = true;
      inputWrapper.classList.add('loading');

      try {
        const response = await fetch("https://api.x.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${XAI_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: MODEL_ID,
            messages: [
              { role: "system", content: SYSTEM_PROMPT },
              { role: "user", content: query }
            ],
            max_completion_tokens: 2048,
            temperature: 0.7
          })
        });

        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error?.message || "Connection Error");
        }

        if (data.choices && data.choices[0]) {
          appendMessage('ai', data.choices[0].message.content);
        }
      } catch (err) {
        appendMessage('ai', "I encountered a technical issue. Please try again or check your internet connection.");
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        inputWrapper.classList.remove('loading');
        userInput.focus();
      }
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
  </script>
</body>
</html>
